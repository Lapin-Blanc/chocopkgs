<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur chocolatey</title>
</head>
<body>
    <h1>Packages</h1>
    <div id='app'>
    <!-- {% verbatim %} -->

        <div v-for="package in packages">
            <package-item :package='package'></package-item>
        </div>
        <br>
        <button @click="downloadScript">Télécharger le script d'installation</button>
    </div>

    <script type='x-template' id='package-item-template'>
        <div>
            <input type="checkbox" v-model="package.selected" v-bind:id="'pack'+package.id"/>
            <label v-bind:for="'pack'+package.id"><strong>{{ package.software}}:&nbsp;</strong></label>
            <span>{{ package.description }}</span>
        </div>
    </script>

    <!-- {% endverbatim %} -->

    <script src='https://unpkg.com/vue'></script>
    <script>
        Vue.component('package-item',{
            props : ['package'],
            template : '#package-item-template'
        })
        
        new Vue({
            el: '#app',
            data: {
                packages: [ 
                {% for package in object_list %}
                        {
                            id: '{{ package.id}}',
                            name: '{{package.package_name}}',
                            software: '{{package.software_name}}',
                            description: '{{package.software_description}}',
                            selected: {% if package.selected_by_default %}true{% else %}false{% endif %},
                        },
                {% endfor %}
                        // {
                        // id: '1',
                        // name: 'vlc',
                        // software: 'VLC',
                        // description: 'lecteur multimedia polyvalent',
                        // selected: true,
                        // },
                        // {
                        // id: '2',
                        // name: 'googlechrome',
                        // software: 'Google Chrome',
                        // description: 'Navigateur Google',
                        // selected: true,
                        // },
                        // {
                        // id: '3',
                        // name: 'vscode',
                        // software: 'Visual Studio Code',
                        // description: 'Éditeur de code Microsoft',
                        // selected: true,
                        // }
                    ]
            },
            methods: {
                downloadScript () {
                    msg = `@echo off\n@"%SystemRoot%\\System32\\WindowsPowerShell\\v1.0\\powershell.exe" -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command "iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))" && SET "PATH=%PATH%;%ALLUSERSPROFILE%\\chocolatey\\bin"\n`;
                    this.packages.forEach(element => {
                        if (element.selected === true) {
                            msg += "choco install -y " + element.name + "\n"
                        }                        
                    });
                    msg += 'pause\n'
                    console.log(msg);
                    download(msg, 'toto.bat', 'text', 'text/plain;charset=utf-8;');
                }
            }

        });
        // Function to download data to a file
        function download(data, filename, type) {
            var file = new Blob([data], {type: type});
            if (window.navigator.msSaveOrOpenBlob) // IE10+
                window.navigator.msSaveOrOpenBlob(file, filename);
            else { // Others
                var a = document.createElement("a"),
                        url = URL.createObjectURL(file);
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(function() {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);  
                }, 0); 
            }
        }
    </script>
</body>
</html>